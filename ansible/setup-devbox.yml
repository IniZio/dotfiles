---
- name: Host Setup (LXD & Network)
  hosts: localhost
  connection: local
  gather_facts: false
  become: true
  vars:
    container_name: "{{ target_container | default('devbox') }}"
    host_uid: 1003
    host_gid: 1003
    network_interface: "enp100s0"

  tasks:
    - name: Enable IP Forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        sysctl_set: true
        state: present

    - name: Configure IPTables NAT
      iptables:
        table: nat
        chain: POSTROUTING
        out_interface: "{{ network_interface }}"
        jump: MASQUERADE

    - name: Configure IPTables Forwarding (In)
      iptables:
        chain: FORWARD
        in_interface: lxdbr0
        out_interface: "{{ network_interface }}"
        jump: ACCEPT

    - name: Configure IPTables Forwarding (Out)
      iptables:
        chain: FORWARD
        in_interface: "{{ network_interface }}"
        out_interface: lxdbr0
        match: state
        ctstate: RELATED,ESTABLISHED
        jump: ACCEPT

    - name: Ensure LXD Profile Exists
      shell: |
        lxc profile show devbox || lxc profile create devbox
      register: profile_check
      changed_when: profile_check.rc != 0
      failed_when: profile_check.rc != 0 and "not found" not in profile_check.stderr

    - name: Configure LXD Profile (Nesting & ID Map)
      shell: |
        lxc profile set devbox security.nesting=true
        lxc profile set devbox limits.memory=8GB
        lxc profile set devbox limits.cpu=4
        lxc profile set devbox raw.idmap="uid {{ host_uid }} {{ host_uid }}
        gid {{ host_gid }} {{ host_gid }}"
      changed_when: false

    - name: Launch Container
      shell: |
        lxc launch ubuntu:25.10 {{ container_name }} --profile default --profile devbox
      args:
        creates: "/var/lib/lxd/containers/{{ container_name }}"
      register: container_launch
      failed_when: container_launch.rc != 0 and "already exists" not in container_launch.stderr

    - name: Map Host Volume
      shell: |
        lxc config device add {{ container_name }} magic disk source=/home/newman/magic/{{ container_name }} path=/home/newman/magic/{{ container_name }}
      register: device_add
      failed_when: device_add.rc != 0 and "already exists" not in device_add.stderr

    - name: Wait for IP Address
      shell: lxc list {{ container_name }} --format json | jq -r '.[0].state.network.eth0.addresses[] | select(.family=="inet") | .address'
      register: container_ip
      until: container_ip.stdout != ""
      retries: 20
      delay: 3
      changed_when: false

    - name: Add Container to Inventory
      add_host:
        name: "{{ container_name }}"
        ansible_connection: lxd
        ansible_user: root  # Connect as root initially to create user

- name: Container Provisioning
  hosts: "{{ target_container | default('devbox') }}"
  gather_facts: false
  vars:
    user: newman
    uid: 1003
    gid: 1003

  tasks:
    - name: Install System Dependencies
      raw: apt-get update && apt-get install -y git curl python3 uidmap snapd
      changed_when: false

    - name: Gather Facts
      setup:

    - name: Create Group
      group:
        name: "{{ user }}"
        gid: "{{ gid }}"

    - name: Create Docker Group
      group:
        name: docker
        state: present

    - name: Create User
      user:
        name: "{{ user }}"
        uid: "{{ uid }}"
        group: "{{ user }}"
        groups: sudo,docker
        shell: /bin/bash
        append: true
        create_home: true

    - name: Fix Home Directory Permissions
      file:
        path: "/home/{{ user }}"
        state: directory
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: '0755'
        recurse: no

    - name: Ensure .ssh directory
      file:
        path: "/home/{{ user }}/.ssh"
        state: directory
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: '0700'

    - name: Copy SSH Keys from Host
      copy:
        src: "/home/newman/.ssh/{{ item }}"
        dest: "/home/{{ user }}/.ssh/{{ item }}"
        owner: "{{ user }}"
        group: "{{ user }}"
        mode: '0600'
      with_items:
        - id_ed25519
        - id_ed25519.pub

    - name: Add IniZio GitHub Keys to Authorized Keys
      authorized_key:
        user: "{{ user }}"
        state: present
        key: "https://github.com/IniZio.keys"

    - name: Install Chezmoi (Snap)
      shell: snap install chezmoi --classic
      args:
        creates: /snap/bin/chezmoi

    - name: Initialize Dotfiles (Chezmoi)
      shell: |
        /snap/bin/chezmoi init git@github.com:IniZio/dotfiles.git
      args:
        creates: "/home/{{ user }}/.local/share/chezmoi"
      become: true
      become_user: "{{ user }}"
      environment:
        GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no"

    - name: Apply Dotfiles (Chezmoi)
      shell: |
        /snap/bin/chezmoi apply
      become: true
      become_user: "{{ user }}"

    - name: Install Nix (Determinate Systems)
      shell: |
        curl -fsSL https://install.determinate.systems/nix | sh -s -- install --no-confirm
      args:
        creates: /nix/var/nix/db

    - name: Add Home Manager Channel
      shell: |
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
        nix-channel --update
      args:
        creates: "/home/{{ user }}/.nix-channels"
      become: true
      become_user: "{{ user }}"

    - name: Install Home Manager
      shell: |
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        nix-shell '<home-manager>' -A install
      args:
        creates: "/home/{{ user }}/.config/home-manager/home.nix"
      become: true
      become_user: "{{ user }}"

    - name: Apply Flake Configuration
      shell: |
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        home-manager switch --flake ~/nix#newman@devbox
      become: true
      become_user: "{{ user }}"
      args:
        executable: /bin/bash

    - name: Install Tailscale
      shell: curl -fsSL https://tailscale.com/install.sh | sh
      args:
        creates: /usr/sbin/tailscale

    - name: Install Docker & Compose
      raw: apt-get install -y docker.io docker-compose-v2
      changed_when: false

    - name: Ensure Docker Service is Started
      service:
        name: docker
        state: started
        enabled: yes
